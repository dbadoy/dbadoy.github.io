---
layout: post
title:  "CAP"
tags: Distributed-system
---
**Consistency, Availability, Partition-Tolerance**

분산 데이터베이스에서는 위 세 가지 중 두 가지만 제공할 수 있다고 말합니다.

(; 메세지가 손실될 수 있는 비동기식 네트워크에서는 모든 메세지 손실 패턴에서 모든 요청에 응답하는 순차적으로 일관된 읽기/쓰기 레지스터를 구현하는 것이 불가능하다.)

단 해당 이론에는 Partition Tolerance에 대한 정의가 부족하다는 문제가 제기 되거나, 분산 시스템에는 더 많은 요소들이 있다고 주장하는 의견도 있는 만큼 참고만 하는 것이 좋아보입니다.

### Consistency (일관성)

모든 클라이언트가 동시에 동일 데이터를 볼 수 있습니다. 모든 읽기는 가장 최근에 쓰인 값이나 에러를 수신합니다.

### Availability (유효성)

하나 이상의 노드가 작동 중지된 경우에도 클라이언트가 응답을 받을 수 있습니다. 가장 최근에 쓰인 값이 포함되어 있다는 보장 없이 응답을 수신합니다. 

### Partition Tolerance (파티션 허용 = 분할 내구성)

분산 시스템 내의 통신 단절, 네트워크 및  노드의 연결 유실 등으로 네트워크가 분리되었을 때도 시스템이 작동해야 합니다.

Partition Tolerance는 크게 아래의 두 행동을 할 수 있습니다.

- 작업을 취소하여 가용성을 희생하여 일관성을 보장합니다.
- 작업을 진행하여 가용성을 제공하지만 일관성을 희생합니다.

CAP에서 말하는 일관성은 transaction의 ACID에서의 일관성과는 많이 다릅니다.

> Transaction ACID의 일관성?
트랜잭션이 일어난 이후의 데이터베이스는 데이터베이스의 제약이나 규칙을 만족해야 한다.
> 

그러나 분산 시스템은 네트워크 장애로부터 안전하지 않으므로 네트워크 분할을 허용해야 합니다. 따라서 CAP에 따르면 일관성, 유효성  중 하나만 선택할 수 있게 됩니다.

**각 모델에 따른 허점**

### CP 모델

완벽한 일관성을 가져야 하는 시스템에서 사용합니다. 데이터 변경은 모든 노드에 복제되어야 완료됩니다. 가용성이나 성능이 크게 희생됩니다(만약 하나의 노드라도 문제가 있으면 트랜잭션이 실패되며 노드가 늘어날 수록 지연시간이 길어집니다).

### CA 모델

일관성과 가용성을 모두 만족하려면 네트워크 장애를 허용하지 않아야 합니다. 그러나 네트워크 장애가 없는 시스템은 없기 때문에 모델 구성에 ‘P’가 필수적이게 됩니다.

### AP 모델

가용성을 갖는 분산 시스템은 모든 노드가 어떤 상황에서도 응답할 수 있어야 합니다. 만약 네트워크 문제로 인하여 어떤 노드에 복제가 제대로 이루어지지 않더라도 가용성을 위하여 동기화 되지 않은 데이터를 사용자에게 반환합니다. 때문에 일관성을 갖지 못하고, 사용자는 문제 발생을 알아차리지 못하게 됩니다.

보통 분산 데이터베이스는 복제와 샤딩 기능을 지원합니다. 복제 기능으로 인하여 모든 노드가 동일한 데이터를 가져 일관성을 충족합니다. 샤딩을 통해 데이터를 각 노드에 나눠서 저장하기 때문에 유효성도 얻을 수 있습니다.

NoSQL 같은 경우는 데이터의 전파를 느슨하게 처리합니다. 데이터의 변경을 시간의 흐름에 따라 여러 노드로 전파하죠. 이러한 방법을 최종 일관성(Eventual consistency)라고 합니다.

이 방법에서는 두가지 방법을 통해 노드간 데이터 동기화를 이룹니다.

1. 데이터의 저장 결과를 클라이언트로 응답하기 전에 모든 데이터를 저장하는 동기식 방법. 느리지만 데이터의 일관성을 보장합니다.
2. 메모리나 임시 파일에 기록하여 클라이언트에 응답한 뒤, 이벤트 및 프로세스를 사용하여 노드로 데이터를 동기화하는 비동기식 방법. 빠른 응답시간을 갖지만 쓰는 과정에서 장애가 발생하면 데이터 손실이 일어날 수 있습니다.
